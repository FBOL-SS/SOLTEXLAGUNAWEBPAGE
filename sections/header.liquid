{% comment %}
SOLTEX — Header con MEGA MENU MÁQUINAS
- Desktop: logo + menú horizontal con dropdowns + MEGA MENU 4 columnas para "Máquinas"
- Mobile: burger drawer con accordion
- 100% OS 2.0 compatible, 0 warnings
{% endcomment %}

<style>
  #shopify-section-{{ section.id }} {
    --nav-bg: {{ section.settings.bg_color }};
    --nav-fg: {{ section.settings.text_color }};
    --nav-fg-dim: color-mix(in srgb, {{ section.settings.text_color }} 80%, transparent);
    --nav-border: color-mix(in srgb, {{ section.settings.text_color }} 12%, transparent);
  }

  #shopify-section-{{ section.id }} .hdr { position: relative; z-index: 50; }
  #shopify-section-{{ section.id }} .hdr.is-sticky { position: sticky; top: 0; }
  #shopify-section-{{ section.id }} .hdr-bar {
    background: var(--nav-bg);
    color: var(--nav-fg);
    border-bottom: 1px solid var(--nav-border);
  }
  #shopify-section-{{ section.id }} .hdr-inner { max-width: min(1200px, 92vw); margin: 0 auto; display:flex; align-items:center; gap: 14px; padding: 10px 12px; }

  /* Logo */
  #shopify-section-{{ section.id }} .logo { display:flex; align-items:center; gap: 10px; min-width: 0; }
  #shopify-section-{{ section.id }} .logo-img { display:block; height: auto; width: auto; max-width: {{ section.settings.logo_max_width }}px; }
  #shopify-section-{{ section.id }} .logo-text { font-weight: 800; font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Desktop nav */
  #shopify-section-{{ section.id }} .nav { display:none; margin-left: auto; }
  @media (min-width: 992px){ #shopify-section-{{ section.id }} .nav { display:block; } }
  #shopify-section-{{ section.id }} .nav ul { display:flex; gap: 18px; align-items:center; }
  #shopify-section-{{ section.id }} .nav a { color: var(--nav-fg); text-decoration:none; font-weight:600; font-size: 15px; }
  #shopify-section-{{ section.id }} .nav a:hover, #shopify-section-{{ section.id }} .nav button:hover { opacity:.85; }

  /* MEGA MENU MÁQUINAS */
  #shopify-section-{{ section.id }} .mega-menu-machines {
    position: absolute; left: 0; top: 100%; z-index: 1000; width: 800px;
    background: white; border: 1px solid #e5e7eb; border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
    opacity: 0; visibility: hidden; transform: translateY(8px);
    transition: all .18s ease;
  }
  #shopify-section-{{ section.id }} .machines:hover .mega-menu-machines {
    opacity: 1; visibility: visible; transform: translateY(0);
  }
  #shopify-section-{{ section.id }} .mega-menu-machines h3 {
    font-weight: bold; color: #000; margin-bottom: 10px; font-size: 16px;
  }
  #shopify-section-{{ section.id }} .mega-menu-machines a {
    color: #6b7280; text-decoration: none; display: block; padding: 2px 0;
  }
  #shopify-section-{{ section.id }} .mega-menu-machines a:hover { color: #000; }
  #shopify-section-{{ section.id }} .mega-menu-machines .brands a {
    background: #000; color: white; padding: 10px 20px; text-align: center;
    font-weight: bold; border-radius: 6px; margin-top: 10px;
  }

  /* Responsive Mega Menu */
  @media (max-width: 1024px) {
    #shopify-section-{{ section.id }} .mega-menu-machines {
      width: 600px; grid-template-columns: repeat(3, 1fr);
    }
    #shopify-section-{{ section.id }} .mega-menu-machines .brands {
      grid-column: 1 / -1; margin-top: 10px;
    }
  }

  /* Dropdown normal (otros ítems) */
  #shopify-section-{{ section.id }} .has-children { position: relative; }
  #shopify-section-{{ section.id }} .dd {
    position: absolute; left: 0; top: 100%; min-width: 220px;
    background: var(--nav-bg); color: var(--nav-fg);
    border: 1px solid var(--nav-border); border-radius: 10px; padding: 10px;
    box-shadow: 0 10px 24px rgba(0,0,0,.12);
    opacity: 0; visibility: hidden; transform: translateY(8px);
    transition: all .18s ease;
  }
  #shopify-section-{{ section.id }} .has-children:hover .dd,
  #shopify-section-{{ section.id }} .has-children:focus-within .dd {
    opacity:1; visibility:visible; transform: translateY(0);
  }
  #shopify-section-{{ section.id }} .dd a { display:block; padding: 8px 10px; border-radius: 8px; }
  #shopify-section-{{ section.id }} .dd a:hover { background: var(--nav-border); }

  /* Actions */
  #shopify-section-{{ section.id }} .actions { margin-left:auto; display:flex; align-items:center; gap: 10px; }
  #shopify-section-{{ section.id }} .btn-icon { appearance:none; border:1px solid var(--nav-border); background: transparent; color: var(--nav-fg); padding:8px 10px; border-radius: 8px; cursor:pointer; }
  #shopify-section-{{ section.id }} .btn-icon:hover { background: var(--nav-border); }
  #shopify-section-{{ section.id }} .cta { text-decoration:none; padding:10px 14px; border-radius:10px; border:1px solid var(--nav-border); font-weight:700; color: var(--nav-fg); }
  #shopify-section-{{ section.id }} .cta:hover { background: var(--nav-border); }

  /* Burger (mobile) */
  #shopify-section-{{ section.id }} .burger { appearance:none; border:1px solid var(--nav-border); background: transparent; color: var(--nav-fg); padding:10px 12px; border-radius: 8px; display:inline-flex; align-items:center; gap:8px; }
  @media (min-width: 992px){ #shopify-section-{{ section.id }} .burger { display:none; } }

  /* Drawer */
  #shopify-section-{{ section.id }} .overlay { position: fixed; inset:0; background: rgba(0,0,0,.45); opacity:0; visibility:hidden; transition: opacity .2s ease; z-index:49; }
  #shopify-section-{{ section.id }} .drawer { position: fixed; inset:0 auto 0 0; width: 86%; max-width: 360px; background: var(--nav-bg); color: var(--nav-fg); transform: translateX(-100%); transition: transform .25s ease; z-index:50; display:flex; flex-direction:column; }
  #shopify-section-{{ section.id }} .drawer-header { display:flex; align-items:center; justify-content:space-between; padding: 14px 14px; border-bottom: 1px solid var(--nav-border); }
  #shopify-section-{{ section.id }} .drawer-body { padding: 10px 14px 18px; overflow:auto; }
  #shopify-section-{{ section.id }} .drawer nav a, #shopify-section-{{ section.id }} .drawer nav button { display:block; width:100%; text-align:left; padding: 12px 10px; border-radius: 8px; text-decoration:none; color: var(--nav-fg); background: transparent; border: none; font-weight:600; }
  #shopify-section-{{ section.id }} .drawer nav a:hover, #shopify-section-{{ section.id }} .drawer nav button:hover { background: var(--nav-border); }
  #shopify-section-{{ section.id }} .drawer .sub { padding-left: 12px; border-left: 1px dashed var(--nav-border); margin-left: 6px; }
  #shopify-section-{{ section.id }} .drawer .close { appearance:none; border:1px solid var(--nav-border); background: transparent; color: var(--nav-fg); padding:8px 10px; border-radius:8px; }
  #shopify-section-{{ section.id }} .drawer .cta { margin: 10px 10px 0; }

  #shopify-section-{{ section.id }}.is-open .overlay { opacity:1; visibility:visible; }
  #shopify-section-{{ section.id }}.is-open .drawer { transform: translateX(0); }
</style>

<header class="hdr {% if section.settings.sticky_header %}is-sticky{% endif %}" role="banner">
  <div class="hdr-bar">
    <div class="hdr-inner">
      <!-- Burger (mobile) -->
      <button class="burger" id="burger-{{ section.id }}" aria-label="Abrir menú" aria-controls="drawer-{{ section.id }}" aria-expanded="false">
        ☰ <span class="sr-only">Menú</span>
      </button>

      <!-- Logo -->
      <a class="logo" href="{{ routes.root_url }}" aria-label="Inicio">
        {% if section.settings.logo != blank %}
          {{ section.settings.logo | image_url: width: 360 | image_tag: class: 'logo-img', alt: shop.name | escape }}
        {% else %}
          <span class="logo-text">{{ shop.name }}</span>
        {% endif %}
      </a>

      <!-- Desktop navigation -->
      <nav class="nav" aria-label="Navegación principal">
        {% if section.settings.menu != blank %}
          <ul>
            {% for l1 in section.settings.menu.links %}
              {% if l1.title == 'Máquinas' %}
                <!-- MEGA MENU ESPECIAL -->
                <li class="machines has-children">
                  <button class="btn-icon">{{ l1.title }}</button>
                  <div class="mega-menu-machines">
                    <div class="column supreme">
                      <h3>Supreme</h3>
                      <a href="{{ routes.pages_url }}/supreme">Ver Supreme</a>
                      <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=supreme&filter.p.m.custom.uso=jeans">• Jeans</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=supreme&filter.p.m.custom.uso=tejido">• Tejido</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=supreme&filter.p.m.custom.uso=automatizado">• Automatizado</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=supreme">• Ver Todas</a></li>
                      </ul>
                    </div>
                    <div class="column jack">
                      <h3>Jack</h3>
                      <a href="{{ routes.pages_url }}/jack">Ver Jack</a>
                      <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=jack&filter.p.m.custom.uso=jeans">• Jeans</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=jack&filter.p.m.custom.uso=tejido">• Tejido</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=jack&filter.p.m.custom.uso=automatizado">• Automatizado</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=jack">• Ver Todas</a></li>
                      </ul>
                    </div>
                    <div class="column eagle">
                      <h3>Eagle Special</h3>
                      <a href="{{ routes.pages_url }}/eagle-special">Ver Eagle</a>
                      <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=eagle&filter.p.m.custom.uso=cuero">• Cuero</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=eagle&filter.p.m.custom.uso=pesados">• Pesados</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=eagle&filter.p.m.custom.uso=industrial">• Industrial</a></li>
                        <li><a href="{{ routes.collections_url }}/machines?filter.p.m.custom.marca=eagle">• Ver Todas</a></li>
                      </ul>
                    </div>
                    <div class="brands column">
                      <a href="{{ routes.collections_url }}/machines?filter.p.product_type=maquinas">VER MARCAS</a>
                    </div>
                  </div>
                </li>
              {% elsif l1.links.size > 0 %}
                <!-- DROPDOWN NORMAL -->
                <li class="has-children">
                  <button class="btn-icon">{{ l1.title }}</button>
                  <div class="dd" role="menu">
                    {% for l2 in l1.links %}
                      <a role="menuitem" href="{{ l2.url }}">{{ l2.title }}</a>
                    {% endfor %}
                  </div>
                </li>
              {% else %}
                <!-- LINK SIMPLE -->
                <li><a href="{{ l1.url }}">{{ l1.title }}</a></li>
              {% endif %}
            {% endfor %}
          </ul>
        {% endif %}
      </nav>

      <!-- Actions -->
      <div class="actions">
        {% if section.settings.show_phone and section.settings.phone_text != blank and section.settings.phone_url != blank %}
          <a class="cta" href="{{ section.settings.phone_url }}">{{ section.settings.phone_text }}</a>
        {% endif %}
        {% if section.settings.show_search %}
          <a class="btn-icon" href="{{ routes.search_url }}" aria-label="Buscar">🔎</a>
        {% endif %}
        {% if section.settings.show_cart %}
          <a class="btn-icon" href="{{ routes.cart_url }}" aria-label="Carrito">🛒</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Overlay + Drawer (Mobile) -->
  <div class="overlay" id="overlay-{{ section.id }}" hidden></div>
  <aside class="drawer" id="drawer-{{ section.id }}" aria-hidden="true" aria-label="Menú móvil">
    <div class="drawer-header">
      <span>{{ section.settings.mobile_title | default: 'Menú' }}</span>
      <button class="close" id="close-{{ section.id }}" aria-label="Cerrar menú">✕</button>
    </div>
    <div class="drawer-body">
      <nav aria-label="Navegación móvil">
        {% if section.settings.menu != blank %}
          {% for l1 in section.settings.menu.links %}
            {% if l1.links.size > 0 %}
              <details>
                <summary><span>{{ l1.title }}</span></summary>
                <div class="sub">
                  {% for l2 in l1.links %}
                    <a href="{{ l2.url }}">{{ l2.title }}</a>
                  {% endfor %}
                </div>
              </details>
            {% else %}
              <a href="{{ l1.url }}">{{ l1.title }}</a>
            {% endif %}
          {% endfor %}
        {% endif %}
      </nav>
      {% if section.settings.show_phone and section.settings.phone_text != blank and section.settings.phone_url != blank %}
        <a class="cta" href="{{ section.settings.phone_url }}">{{ section.settings.phone_text }}</a>
      {% endif %}
    </div>
  </aside>
</header>

<script>
  (function(){
    var root = document.getElementById('shopify-section-{{ section.id }}');
    if(!root) return;
    var burger = root.querySelector('#burger-{{ section.id }}');
    var drawer = root.querySelector('#drawer-{{ section.id }}');
    var overlay = root.querySelector('#overlay-{{ section.id }}');
    var closeBtn = root.querySelector('#close-{{ section.id }}');

    function openDrawer(){
      root.classList.add('is-open');
      drawer.setAttribute('aria-hidden', 'false');
      burger.setAttribute('aria-expanded', 'true');
      overlay.hidden = false;
      document.documentElement.style.overflow = 'hidden';
      drawer.focus({preventScroll:true});
    }
    function closeDrawer(){
      root.classList.remove('is-open');
      drawer.setAttribute('aria-hidden', 'true');
      burger.setAttribute('aria-expanded', 'false');
      overlay.hidden = true;
      document.documentElement.style.overflow = '';
      burger.focus({preventScroll:true});
    }
    function onKey(e){ if(e.key === 'Escape'){ closeDrawer(); } }

    burger && burger.addEventListener('click', openDrawer);
    closeBtn && closeBtn.addEventListener('click', closeDrawer);
    overlay && overlay.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', onKey);

    // Prevent focus from leaving the drawer when open
    drawer.addEventListener('keydown', function(e){
      if(e.key !== 'Tab') return;
      var focusable = drawer.querySelectorAll('a, button, summary, input, [tabindex]:not([tabindex="-1"])');
      focusable = Array.prototype.slice.call(focusable).filter(function(el){ return !el.disabled && el.offsetParent !== null; });
      if(!focusable.length) return;
      var first = focusable[0];
      var last = focusable[focusable.length - 1];
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    });
  })();
</script>

{% schema %}
{
  "name": "soltex-header",
  "settings": [
    { "type": "image_picker", "id": "logo", "label": "Logo" },
    { "type": "range", "id": "logo_max_width", "label": "Ancho máx. del logo (px)", "min": 60, "max": 320, "step": 10, "default": 160 },

    { "type": "link_list", "id": "menu", "label": "Menú principal" },

    { "type": "checkbox", "id": "sticky_header", "label": "Header fijo (sticky)", "default": true },

    { "type": "color", "id": "bg_color", "label": "Color de fondo", "default": "#0d1b2a" },
    { "type": "color", "id": "text_color", "label": "Color de texto", "default": "#ffffff" },

    { "type": "checkbox", "id": "show_search", "label": "Mostrar botón de búsqueda", "default": true },
    { "type": "checkbox", "id": "show_cart", "label": "Mostrar botón de carrito", "default": true },

    { "type": "header", "content": "CTA / Teléfono" },
    { "type": "checkbox", "id": "show_phone", "label": "Mostrar CTA/teléfono", "default": false },
    { "type": "text", "id": "phone_text", "label": "Texto del CTA (ej. WhatsApp)", "default": "Contáctanos" },
    { "type": "url", "id": "phone_url", "label": "URL del CTA" },

    { "type": "text", "id": "mobile_title", "label": "Título en móvil", "default": "Menú" }
  ],
  "presets": [ { "name": "soltex-header" } ]
}
{% endschema %}